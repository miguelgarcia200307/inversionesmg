<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Panel de Inventarios - Inversiones MG">
  <title>Inventarios MG - Panel de Control</title>
  
  <!-- Estilos -->
  <link rel="stylesheet" href="estilos/base.css">
  <link rel="stylesheet" href="estilos/admin-corporate.css">
  <link rel="stylesheet" href="estilos/inventory-v2.css">
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- ZXing - LibrerÃ­a de escaneo de cÃ³digos de barras (fallback) -->
  <script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>
  
  <!-- Filtro de errores de extensiones -->
  <script>
    // Suprimir errores de extensiones del navegador
    window.addEventListener('error', function(e) {
      if (e.filename && (e.filename.includes('extension://') || e.filename.includes('content.js'))) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      }
    }, true);
    
    // Suprimir errores no capturados de promesas de extensiones
    window.addEventListener('unhandledrejection', function(e) {
      if (e.reason && e.reason.message && e.reason.message.includes('Extension context invalidated')) {
        e.preventDefault();
        e.stopPropagation();
        return true;
      }
    });
    
    // Ocultar advertencias de Supabase SES
    const originalWarn = console.warn;
    console.warn = function(...args) {
      if (args[0] && typeof args[0] === 'string' && args[0].includes('SES')) {
        return;
      }
      originalWarn.apply(console, args);
    };
  </script>
</head>
<body>
  <!-- Pantalla de login -->
  <div id="loginScreen">
    <div class="login-card">
      <div class="login-logo">
        <div class="login-logo-circle">
          ğŸ“¦
        </div>
      </div>
      <div class="login-header">
        <h1 class="login-title">Inventarios MG</h1>
        <p class="login-subtitle">Sistema de GestiÃ³n de Inventarios</p>
      </div>
      
      <form id="loginForm" class="login-form">
        <div class="login-form-group">
          <label class="login-label" for="loginUser">Usuario</label>
          <div class="login-input-wrapper">
            <span class="login-input-icon">ğŸ‘¤</span>
            <input 
              type="text" 
              id="loginUser" 
              class="login-input" 
              placeholder="Ingresa tu usuario"
              autocomplete="username"
              required
            >
          </div>
        </div>
        
        <div class="login-form-group">
          <label class="login-label" for="loginPassword">ContraseÃ±a</label>
          <div class="login-input-wrapper">
            <span class="login-input-icon">ğŸ”’</span>
            <input 
              type="password" 
              id="loginPassword" 
              class="login-input" 
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              autocomplete="current-password"
              required
              style="padding-right: 3.5rem;"
            >
            <button type="button" class="password-toggle" id="togglePassword" aria-label="Mostrar contraseÃ±a">
              ğŸ‘ï¸
            </button>
          </div>
        </div>
        
        <div id="loginError" class="login-error"></div>
        
        <button type="submit" id="btnLogin" class="login-button">
          Iniciar sesiÃ³n
        </button>
      </form>
      
      <div class="login-footer">
        <span>Inversiones MG Â© 2026</span>
      </div>
    </div>
  </div>

  <!-- Panel principal de inventarios -->
  <div id="inventoryPanel" style="display: none;">
    <!-- Overlay del sidebar (mÃ³vil) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="admin-sidebar" id="inventorySidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <span class="sidebar-logo-icon">ğŸ“¦</span>
          <span class="sidebar-logo-text">Inventarios MG</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <button class="nav-item active" data-view="dashboard">
          <span class="nav-icon">ğŸ“Š</span>
          <span class="nav-label">Dashboard</span>
        </button>
        
        <button class="nav-item" data-view="productos">
          <span class="nav-icon">ğŸ“¦</span>
          <span class="nav-label">Productos</span>
        </button>
        
        <button class="nav-item" data-view="ventas">
          <span class="nav-icon">ğŸ’°</span>
          <span class="nav-label">Ventas</span>
        </button>
        
        <button class="nav-item" data-view="compras">
          <span class="nav-icon">ğŸ›’</span>
          <span class="nav-label">Compras</span>
        </button>
        
        <button class="nav-item" data-view="proveedores">
          <span class="nav-icon">ğŸ­</span>
          <span class="nav-label">Proveedores</span>
        </button>
        
        <button class="nav-item" data-view="reportes">
          <span class="nav-icon">ğŸ“ˆ</span>
          <span class="nav-label">Reportes</span>
        </button>
        
        <button class="nav-item" data-view="auditoria">
          <span class="nav-icon">ğŸ“‹</span>
          <span class="nav-label">AuditorÃ­a</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-user">
          <div class="sidebar-user-avatar">ğŸ‘¤</div>
          <div class="sidebar-user-info">
            <div class="sidebar-user-name" id="inventoryUserName">Usuario</div>
            <div class="sidebar-user-role">Inventarios</div>
          </div>
        </div>
        <button class="sidebar-logout" id="btnLogout" title="Cerrar sesiÃ³n">
          ğŸšª
        </button>
      </div>
    </aside>

    <!-- Contenido principal -->
    <main class="admin-main">
      <!-- Topbar -->
      <div class="admin-topbar">
        <button class="topbar-menu-btn" id="btnMenu" aria-label="MenÃº">
          â˜°
        </button>
        
        <h1 class="topbar-title" id="topbarTitle">Dashboard</h1>
        <span class="topbar-date" id="currentDate"></span>
      </div>
      
      <div class="admin-content">
        <!-- Dashboard -->
        <div id="viewDashboard" class="view-content"></div>
        
        <!-- Productos -->
        <div id="viewProductos" class="view-content" style="display: none;"></div>
        
        <!-- Ventas -->
        <div id="viewVentas" class="view-content" style="display: none;"></div>
        
        <!-- Compras -->
        <div id="viewCompras" class="view-content" style="display: none;"></div>
        
        <!-- Proveedores -->
        <div id="viewProveedores" class="view-content" style="display: none;"></div>
        
        <!-- Reportes -->
        <div id="viewReportes" class="view-content" style="display: none;"></div>
        
        <!-- AuditorÃ­a -->
        <div id="viewAuditoria" class="view-content" style="display: none;"></div>
      </div>
    </main>

    <!-- NavegaciÃ³n mÃ³vil inferior -->
    <nav class="mobile-nav">
      <button class="mobile-nav-item active" data-view="dashboard">
        <span class="mobile-nav-icon">ğŸ“Š</span>
        <span class="mobile-nav-label">Inicio</span>
      </button>
      <button class="mobile-nav-item" data-view="productos">
        <span class="mobile-nav-icon">ğŸ“¦</span>
        <span class="mobile-nav-label">Productos</span>
      </button>
      <button class="mobile-nav-item" data-view="ventas">
        <span class="mobile-nav-icon">ğŸ’°</span>
        <span class="mobile-nav-label">Ventas</span>
      </button>
      <button class="mobile-nav-item" onclick="openScanner()">
        <span class="mobile-nav-icon">ğŸ“·</span>
        <span class="mobile-nav-label">Scanner</span>
      </button>
    </nav>
  </div>

  <!-- Modal genÃ©rico -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal" id="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Modal</h3>
        <button class="modal-close" id="modalClose" aria-label="Cerrar modal">Ã—</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-footer" id="modalFooter"></div>
    </div>
  </div>

  <!-- Scanner Overlay Ultra-Moderno -->
  <div class="inv-scanner-overlay" id="scannerOverlay" style="display: none;">
    <!-- Header con status bar nativo -->
    <div class="inv-scanner-header">
      <div class="inv-scanner-status-bar">
        <div class="inv-scanner-status-left">
          <div class="inv-scanner-connection-indicator"></div>
          <span class="inv-scanner-mode-indicator" id="scannerModeIndicator">ESCANEO</span>
        </div>
        <div class="inv-scanner-status-center">
          <div class="inv-scanner-brand">âœ¨ ScannerPro</div>
        </div>
        <div class="inv-scanner-status-right">
          <div class="inv-scanner-battery-indicator">ğŸ”‹</div>
        </div>
      </div>
      
      <div class="inv-scanner-nav">
        <button class="inv-scanner-back-btn" id="scannerClose" aria-label="Cerrar scanner">
          <span class="inv-back-icon">â†</span>
          <span class="inv-back-text">Volver</span>
        </button>
        
        <div class="inv-scanner-title-container">
          <h1 class="inv-scanner-title" id="scannerTitle">CÃ¡mara</h1>
          <p class="inv-scanner-subtitle">Escanear cÃ³digo de barras</p>
        </div>
        
        <div class="inv-scanner-actions">
          <button class="inv-scanner-info-btn" id="scannerInfoBtn" aria-label="InformaciÃ³n">
            <span>â„¹</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Viewport principal -->
    <div class="inv-scanner-viewport">
      <video id="scannerVideo" autoplay playsinline muted webkit-playsinline></video>
      <canvas id="scannerCanvas" style="display: none;"></canvas>
      
      <!-- Loading state -->
      <div class="inv-scanner-loading" id="scannerLoading" style="display: none;">
        <div class="inv-scanner-loading-animation">
          <div class="inv-loading-rings">
            <div class="inv-loading-ring"></div>
            <div class="inv-loading-ring"></div>
            <div class="inv-loading-ring"></div>
          </div>
          <div class="inv-scanner-loading-text">Iniciando cÃ¡mara...</div>
        </div>
      </div>
      
      <!-- Marco de escaneo moderno con animaciones -->
      <div class="inv-scanner-frame" id="scannerFrame">
        <div class="inv-scanner-corners">
          <div class="inv-scanner-corner top-left">
            <div class="inv-corner-inner"></div>
          </div>
          <div class="inv-scanner-corner top-right">
            <div class="inv-corner-inner"></div>
          </div>
          <div class="inv-scanner-corner bottom-left">
            <div class="inv-corner-inner"></div>
          </div>
          <div class="inv-scanner-corner bottom-right">
            <div class="inv-corner-inner"></div>
          </div>
        </div>
        
        <!-- LÃ­nea de escaneo mejorada -->
        <div class="inv-scanner-line-container">
          <div class="inv-scanner-line">
            <div class="inv-line-glow"></div>
          </div>
        </div>
        
        <!-- Indicador de zona activa -->
        <div class="inv-scanner-zone-indicator">
          <div class="inv-zone-pulse"></div>
        </div>
      </div>
      
      <!-- Instrucciones flotantes -->
      <div class="inv-scanner-instructions-floating" id="scannerInstructionsBox">
        <div class="inv-instructions-card">
          <div class="inv-instructions-icon">ğŸ“±</div>
          <div class="inv-instructions-content">
            <div class="inv-scanner-instructions-title" id="scannerInfo">MantÃ©n el cÃ³digo en el marco</div>
            <div class="inv-scanner-instructions-text">AsegÃºrate de que haya buena iluminaciÃ³n</div>
          </div>
        </div>
      </div>
      
      <!-- Tips emergentes -->
      <div class="inv-scanner-tips" id="scannerTips" style="display: none;">
        <div class="inv-tips-card">
          <div class="inv-tips-header">
            <span class="inv-tips-icon">ğŸ’¡</span>
            <span class="inv-tips-title">Consejos de escaneo</span>
          </div>
          <div class="inv-tips-list">
            <div class="inv-tip-item">â€¢ MantÃ©n el cÃ³digo bien iluminado</div>
            <div class="inv-tip-item">â€¢ AsegÃºrate de que estÃ© enfocado</div>
            <div class="inv-tip-item">â€¢ MantÃ©n una distancia de 10-30cm</div>
          </div>
        </div>
      </div>
      
      <!-- Estado de Ã©xito -->
      <div class="inv-scanner-success" id="scannerSuccess" style="display: none;">
        <div class="inv-success-animation">
          <div class="inv-success-circle">
            <div class="inv-success-checkmark">
              <div class="inv-checkmark-stem"></div>
              <div class="inv-checkmark-kick"></div>
            </div>
          </div>
          <div class="inv-success-text">Â¡CÃ³digo detectado!</div>
        </div>
      </div>
    </div>
    
    <!-- Controles inferiores tipo app nativa -->
    <div class="inv-scanner-controls">
      <div class="inv-scanner-controls-top">
        <!-- Selector de cÃ¡mara mejorado -->
        <div class="inv-camera-selector" id="cameraSelectorContainer" style="display: none;">
          <button class="inv-camera-toggle" id="cameraToggleBtn">
            <span class="inv-camera-icon">ğŸ“·</span>
            <span class="inv-camera-text">Cambiar cÃ¡mara</span>
          </button>
          <select id="cameraSelect" class="inv-camera-select">
            <option value="">Seleccionar cÃ¡mara...</option>
          </select>
        </div>
        
        <!-- Indicador de estado activo -->
        <div class="inv-scanner-active-indicator" id="scannerActiveIndicator" style="display: none;">
          <div class="inv-active-dot"></div>
          <span class="inv-active-text">Escaneando...</span>
          <div class="inv-active-waves">
            <div class="inv-wave"></div>
            <div class="inv-wave"></div>
            <div class="inv-wave"></div>
          </div>
        </div>
      </div>
      
      <!-- Botones de acciÃ³n principales -->
      <div class="inv-scanner-action-bar">
        <button class="inv-scanner-action-btn secondary" id="scannerManualInput">
          <div class="inv-action-btn-content">
            <span class="inv-action-icon">âŒ¨ï¸</span>
            <span class="inv-action-text">Manual</span>
          </div>
        </button>
        
        <button class="inv-scanner-main-action" id="scannerMainAction">
          <div class="inv-main-action-bg"></div>
          <div class="inv-main-action-content">
            <span class="inv-main-action-icon">ğŸ”</span>
          </div>
          <div class="inv-main-action-pulse"></div>
        </button>
        
        <button class="inv-scanner-action-btn secondary" id="scannerToggleFlash" style="display: none;">
          <div class="inv-action-btn-content">
            <span class="inv-action-icon">ğŸ”¦</span>
            <span class="inv-action-text">Flash</span>
          </div>
        </button>
      </div>
    </div>
    
    <!-- Fallback mejorado -->
    <div class="inv-scanner-fallback" id="scannerFallback" style="display: none;">
      <div class="inv-fallback-container">
        <div class="inv-fallback-header">
          <div class="inv-fallback-icon">ğŸ“</div>
          <h3 class="inv-fallback-title">Entrada Manual</h3>
          <p class="inv-fallback-subtitle">Tu dispositivo no soporta escaneo automÃ¡tico</p>
        </div>
        
        <div class="inv-fallback-form">
          <div class="inv-input-group">
            <label class="inv-input-label">CÃ³digo de barras</label>
            <div class="inv-input-container">
              <input type="text" id="manualBarcodeInput" placeholder="Ingresa el cÃ³digo..." class="inv-manual-input">
              <button class="inv-input-clear" id="clearManualInput" style="display: none;">âœ•</button>
            </div>
          </div>
          
          <button id="btnManualBarcodeSubmit" class="inv-fallback-submit">
            <span class="inv-submit-icon">ğŸ”</span>
            <span class="inv-submit-text">Buscar Producto</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastInventory" class="toast"></div>

  <!-- Scripts -->
  <script src="scripts/config.js"></script>
  <script src="scripts/supabaseClient.js"></script>
  <script src="scripts/supabaseInventory.js"></script>
  <script src="scripts/inventory.js"></script>
</body>
</html>
